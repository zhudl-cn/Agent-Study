# Day 4: é‡åŒ–åº•å±‚é€»è¾‘ - Q4_K_M æ·±åº¦è§£æ

> å­¦ä¹ æ—¥æœŸï¼š2026-01-26
> ç›®æ ‡ï¼šé˜…è¯» `ggml-quants.c`ï¼Œç†è§£ Q4_K_M çš„ block-wise å­˜å‚¨ç»“æ„

---

## ä¸€ã€ä¸ºä»€ä¹ˆéœ€è¦é‡åŒ–ï¼Ÿ

### 1.1 æ¨¡å‹å¤§å°å¯¹æ¯”

| ç²¾åº¦ | 7B æ¨¡å‹å¤§å° | è®¡ç®—æ–¹å¼ |
|------|------------|---------|
| FP32 | 28 GB | 7B Ã— 4 bytes |
| FP16 | 14 GB | 7B Ã— 2 bytes |
| **Q4 (4-bit)** | **~3.5 GB** | 7B Ã— 0.5 bytes |

### 1.2 ç›´æ¥æˆªæ–­çš„é—®é¢˜

1. **ç²¾åº¦ä¸¥é‡æŸå¤±**ï¼š4-bit åªèƒ½è¡¨ç¤º 16 ä¸ªå€¼ (0-15)ï¼ŒFP32 å¯è¡¨ç¤ºçº¦ 40 äº¿ä¸ªå€¼
2. **åŠ¨æ€èŒƒå›´é—®é¢˜**ï¼šä¸åŒå±‚çš„æƒé‡åˆ†å¸ƒä¸åŒï¼Œç»Ÿä¸€æ˜ å°„ä¼šå¯¼è‡´ç²¾åº¦ä¸å‡è¡¡

### 1.3 è§£å†³æ–¹æ¡ˆï¼šBlock-wise Quantization

æ ¸å¿ƒæ€æƒ³ï¼šæŠŠæƒé‡åˆ†æˆå°å— (block)ï¼Œæ¯ä¸ª block æœ‰è‡ªå·±çš„ç¼©æ”¾å› å­å’Œåç§»é‡ã€‚

```
åŸå§‹å€¼ = é‡åŒ–å€¼ Ã— scale + offset
```

---

## äºŒã€Q4_K æ•°æ®ç»“æ„

### 2.1 å…³é”®å¸¸é‡å®šä¹‰

```cpp
// ggml/src/ggml-common.h è¡Œ 89-90
#define QK_K 256        // ä¸€ä¸ª super-block å­˜å‚¨ 256 ä¸ªæƒé‡
#define K_SCALE_SIZE 12 // scales æ•°ç»„å¤§å°
```

### 2.2 block_q4_K ç»“æ„ä½“

```cpp
// ggml/src/ggml-common.h è¡Œ 291-306
typedef struct {
    GGML_EXTENSION union {
        struct {
            ggml_half d;    // super-block scale for quantized scales
            ggml_half dmin; // super-block scale for quantized mins
        } GGML_COMMON_AGGR_S;
        ggml_half2 dm;
    } GGML_COMMON_AGGR_U;
    uint8_t scales[K_SCALE_SIZE]; // scales and mins, quantized with 6 bits
    uint8_t qs[QK_K/2];           // 4-bit quants
} block_q4_K;
```

### 2.3 å­—æ®µè¯¦è§£

| å­—æ®µ | ç±»å‹ | å¤§å° | ä½œç”¨ |
|------|------|------|------|
| `d` | ggml_half (FP16) | 2 bytes | super-block çš„æ•´ä½“ç¼©æ”¾å› å­ |
| `dmin` | ggml_half (FP16) | 2 bytes | super-block çš„æœ€å°å€¼ç¼©æ”¾å› å­ |
| `scales` | uint8_t[12] | 12 bytes | 8 ä¸ªå­å—çš„ scale å’Œ min (6-bit packed) |
| `qs` | uint8_t[128] | 128 bytes | 256 ä¸ª 4-bit é‡åŒ–å€¼ï¼ˆ2ä¸ªå…±ç”¨1å­—èŠ‚ï¼‰ |

### 2.4 Block å¤§å°è®¡ç®—

```
ä¸€ä¸ª block_q4_K:
- å­˜å‚¨æƒé‡æ•°: 256 ä¸ª (QK_K)
- æ€»å¤§å°: 2 + 2 + 12 + 128 = 144 bytes
- å¹³å‡ bits per weight: 144 Ã— 8 / 256 = 4.5 bpw
```

---

## ä¸‰ã€ä¸¤å±‚é‡åŒ–ç»“æ„

### 3.1 ä¸ºä»€ä¹ˆéœ€è¦ä¸¤å±‚ï¼Ÿ

ç›´æ¥å­˜å‚¨ FP32 çš„ scale å’Œ min å¤ªå ç©ºé—´ï¼Œæ‰€ä»¥å¯¹ scale å’Œ min æœ¬èº«ä¹Ÿåšé‡åŒ–ï¼

### 3.2 å±‚çº§ç»“æ„

```
Super-block (256 ä¸ªæƒé‡)
    â”‚
    â”œâ”€â”€ d, dmin (FP16) â† å…¨å±€ç¼©æ”¾å› å­
    â”‚
    â””â”€â”€ 8 ä¸ª Sub-blocks (æ¯ä¸ª 32 ä¸ªæƒé‡)
            â”‚
            â”œâ”€â”€ scale (6-bit) â† å­å—ç¼©æ”¾ç³»æ•°
            â”œâ”€â”€ min (6-bit)   â† å­å—æœ€å°å€¼
            â””â”€â”€ qs[] (4-bit)  â† é‡åŒ–åçš„æƒé‡å€¼
```

### 3.3 scales[12] çš„å«ä¹‰

```
8 ä¸ª sub-blocks Ã— (1 ä¸ª scale + 1 ä¸ª min) Ã— 6 bits = 96 bits = 12 bytes
```

---

## å››ã€é‡åŒ–ä¸åé‡åŒ–

### 4.1 åé‡åŒ–å…¬å¼

```
åŸå§‹å€¼ = (d Ã— scale) Ã— q - (dmin Ã— min)
```

å…¶ä¸­ï¼š
- `d` = super-block ç¼©æ”¾å› å­ (FP16)
- `dmin` = super-block æœ€å°å€¼ç¼©æ”¾å› å­ (FP16)
- `scale` = å­å—ç¼©æ”¾ç³»æ•° (6-bit æ•´æ•°)
- `min` = å­å—æœ€å°å€¼ (6-bit æ•´æ•°)
- `q` = é‡åŒ–åçš„æƒé‡ (4-bit æ•´æ•°, 0-15)

### 4.2 å…·ä½“æ•°å­—ä¾‹å­

å‡è®¾å‚æ•°ï¼š
```
d = 0.01 (FP16)
dmin = 0.008 (FP16)
scale = 50 (6-bit)
min = 100 (6-bit)
q = 7 (4-bit)
```

åé‡åŒ–è®¡ç®—ï¼š
```
åŸå§‹å€¼ = d Ã— scale Ã— q - dmin Ã— min
       = 0.01 Ã— 50 Ã— 7 - 0.008 Ã— 100
       = 3.5 - 0.8
       = 2.7
```

### 4.3 é‡åŒ–è¿‡ç¨‹ç¤ºä¾‹

å‡è®¾ 32 ä¸ªåŸå§‹æƒé‡èŒƒå›´ `[-0.8, 1.2]`ï¼š

```
1. è®¡ç®— scale = (max - min) / 15 = 2.0 / 15 â‰ˆ 0.133
2. è®¡ç®— min = -0.8
3. é‡åŒ–: q = round((åŸå§‹å€¼ - min) / scale)
   
   -0.8 â†’ q = 0
   0.1  â†’ q = 7
   1.2  â†’ q = 15
```

---

## äº”ã€Q4_K å®Œæ•´ç»“æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    block_q4_K (144 bytes, 256 weights)                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ d (2 bytes, FP16) + dmin (2 bytes, FP16)                       â”‚    â”‚
â”‚  â”‚ â†’ Super-block çº§åˆ«çš„ç¼©æ”¾å› å­                                    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ scales[12] (12 bytes)                                          â”‚    â”‚
â”‚  â”‚ â†’ 8 ä¸ª sub-block çš„ scale å’Œ min, 6-bit packed                 â”‚    â”‚
â”‚  â”‚ â†’ æ¯ä¸ª sub-block: 32 ä¸ªæƒé‡                                     â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚ qs[128] (128 bytes)                                            â”‚    â”‚
â”‚  â”‚ â†’ 256 ä¸ª 4-bit é‡åŒ–å€¼ (æ¯å­—èŠ‚å­˜ 2 ä¸ª)                           â”‚    â”‚
â”‚  â”‚ â†’ ä½ 4 ä½ = ç¬¬ i ä¸ªå€¼, é«˜ 4 ä½ = ç¬¬ i+128 ä¸ªå€¼                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ å¹³å‡ bits per weight: 144 Ã— 8 / 256 = 4.5 bpw                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## å…­ã€å¸¸è§é‡åŒ–ç±»å‹å¯¹æ¯”

| ç±»å‹ | Block Size | Bits per Weight | ç‰¹ç‚¹ |
|------|------------|-----------------|------|
| Q4_0 | 32 | 4.5 | ç®€å•é‡åŒ–ï¼Œæ—  min |
| Q4_1 | 32 | 5.0 | æœ‰ min åç§» |
| **Q4_K** | 256 | 4.5 | K-quantï¼Œä¸¤å±‚ç»“æ„ |
| Q5_K | 256 | 5.5 | 5-bit é‡åŒ– |
| Q6_K | 256 | 6.5 | 6-bit é‡åŒ– |
| Q8_0 | 32 | 8.5 | 8-bit é‡åŒ– |

---

## ä¸ƒã€å…³é”®æºç æ–‡ä»¶

| æ–‡ä»¶ | åŠŸèƒ½ |
|------|------|
| `ggml/src/ggml-common.h` | é‡åŒ–ç»“æ„ä½“å®šä¹‰ (block_q4_K ç­‰) |
| `ggml/src/ggml-quants.c` | é‡åŒ–/åé‡åŒ–å‡½æ•°å®ç° |
| `ggml/include/ggml.h` | ggml_type æšä¸¾å®šä¹‰ |

---

## å…«ã€æ€è€ƒé—®é¢˜

1. **ä¸ºä»€ä¹ˆ Q4_K æ¯” Q4_0 æ›´å¥½ï¼Ÿ**
   
   Q4_K ä½¿ç”¨ä¸¤å±‚é‡åŒ–ç»“æ„ï¼Œ256 ä¸ªæƒé‡å…±äº« d/dminï¼Œå‡å°‘äº†å­˜å‚¨å¼€é”€çš„åŒæ—¶ä¿æŒäº†ç²¾åº¦ã€‚

2. **ä¸ºä»€ä¹ˆ block size é€‰æ‹© 256ï¼Ÿ**
   
   å¹³è¡¡ç²¾åº¦å’Œå­˜å‚¨ã€‚è¿‡å° â†’ æ¯ä¸ª block çš„å…ƒæ•°æ®å æ¯”é«˜ï¼›è¿‡å¤§ â†’ åŒä¸€ block å†…æƒé‡å·®å¼‚å¤§ï¼Œç²¾åº¦ä¸‹é™ã€‚

3. **4.5 bpw çš„ "0.5" ä»å“ªæ¥ï¼Ÿ**
   
   æ¥è‡ª d(2) + dmin(2) + scales(12) = 16 bytes çš„å…ƒæ•°æ®ï¼Œåˆ†æ‘Šåˆ° 256 ä¸ªæƒé‡ä¸Šã€‚

---

## ä¹ã€ä¸‹ä¸€æ­¥

Day 5 å°†å­¦ä¹ ï¼š
- **KV Cache æ¢ç§˜**ï¼šè®¡ç®—å¹¶æ‰“å°å½“å‰ Context ä½¿ç”¨çš„ KV Cache æ˜¾å­˜å¤§å°

---

## å‚è€ƒèµ„æ–™

- `ggml/src/ggml-common.h` - ç»“æ„ä½“å®šä¹‰
- `ggml/src/ggml-quants.c` - é‡åŒ–å®ç°
- llama.cpp Wiki: [Quantization](https://github.com/ggerganov/llama.cpp/wiki/Quantization)

---

*ğŸ“ ç¬”è®°å®Œæˆæ—¶é—´: 2026-01-26 22:40*
