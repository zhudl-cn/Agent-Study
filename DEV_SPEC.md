# RAG Assistant Developer Specification

> 版本：0.1 — 文档结构草案

## 目录

- 项目概述
- 核心特点
- 技术选型
- 测试方案
- 系统架构与模块设计
- 项目排期
- 可扩展性与未来展望

---

## 1. 项目概述

### 设计理念 (Design Philosophy)

> **核心定位：智能文档检索助手**
> 
> RAG Assistant 是一个基于 RAG 技术的智能文档检索助手，专注于帮助开发者快速、精准地检索私有知识库中的技术文档。通过语义理解与混合检索技术，让文档搜索变得更加智能高效。

本项目基于 **RAG (Retrieval-Augmented Generation)** 技术设计，采用 **C/S 架构**：后端部署独立的 REST API 服务器，前端通过 **VS Code 扩展** 提供两种交互模式——独立的 **Webview 聊天界面** 或 **Copilot Chat 工具调用**。开发者可以在编辑器中无缝访问私有知识库。

### 硬件支持 (Hardware Support)

> **部署模式：混合架构**
> 
> - **LLM**：通过 **GitHub Copilot** 提供（已有企业订阅），无需本地部署
> - **Embedding / Rerank**：本地运行，不依赖外部 API（企业网络隔离策略）

RAG Assistant 采用**混合架构**设计：

```
┌─────────────────────────────────────────────────────────────────┐
│                    RAG Assistant 混合架构                        │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────────────┐       ┌─────────────────────────────┐  │
│  │   本地运行 (离线)    │       │   云端服务 (Copilot)         │  │
│  ├─────────────────────┤       ├─────────────────────────────┤  │
│  │ • Embedding 模型    │       │ • LLM 推理                  │  │
│  │ • Rerank 模型       │       │ • 答案生成                   │  │
│  │ • 向量数据库        │       │ • (通过 GitHub Copilot 订阅) │  │
│  │ • BM25 索引         │       │                             │  │
│  └─────────────────────┘       └─────────────────────────────┘  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

**硬件要求**：

| 部署模式 | 硬件要求 | 适用场景 | 说明 |
|---------|---------|---------|------|
| **纯 CPU 模式** | CPU (≥4 核)，≥16GB RAM | 开发测试 | Embedding/Rerank 使用 ONNX 加速 |
| **CPU + GPU 模式** | NVIDIA GPU (≥8GB VRAM) | 生产环境 | Embedding/Rerank GPU 加速，更快检索 |

**本地模型选型**（仅 Embedding 和 Rerank，支持可切换）：

> **语言支持：英日混合 (English + Japanese)**

| 模型类型 | 推荐模型 | 语言支持 | 说明 |
|---------|---------|---------|------|
| **Embedding** | `intfloat/multilingual-e5-base` | 🌐 多语言 | 支持 100+ 语言，含英日 |
| **Embedding** | `BAAI/bge-m3` | 🌐 多语言 | 支持多语言 + 多粒度检索 |
| **Embedding (备选)** | `sentence-transformers/paraphrase-multilingual-MiniLM-L12-v2` | 🌐 多语言 | 轻量级，适合 CPU |
| **Rerank** | `BAAI/bge-reranker-v2-m3` | 🌐 多语言 | 多语言重排模型 |
| **Rerank (备选)** | `cross-encoder/ms-marco-MiniLM-L-6-v2` | 🇬🇧 英文 | 轻量级，英文优化 |

> **注意**：LLM 由 GitHub Copilot 提供，无需本地部署。

### 系统架构概览 (Architecture Overview)

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              VS Code 编辑器                                  │
│                                                                             │
│  ┌─────────────────────────────────────────────────────────────────────┐    │
│  │                   RAG Assistant VS Code 扩展                         │    │
│  │                                                                     │    │
│  │   ┌─────────────────────┐       ┌─────────────────────────────┐     │    │
│  │   │  模式 A: Webview    │       │  模式 B: Chat Participant   │     │    │
│  │   │  独立聊天界面        │       │  @rag 命令                  │     │    │
│  │   │  ┌───────────────┐  │       │  集成到 Copilot Chat       │     │    │
│  │   │  │ 💬 聊天框      │  │       │                             │     │    │
│  │   │  │ 📎 文件上传    │  │       │  用户: @rag 搜索文档        │     │    │
│  │   │  │ 📋 历史记录    │  │       │  助手: 找到以下相关内容...  │     │    │
│  │   │  └───────────────┘  │       │                             │     │    │
│  │   └─────────────────────┘       └─────────────────────────────┘     │    │
│  │                    │                          │                     │    │
│  │                    └────────────┬─────────────┘                     │    │
│  │                                 │                                   │    │
│  │                         REST API Client                             │    │
│  └─────────────────────────────────┼───────────────────────────────────┘    │
└────────────────────────────────────┼────────────────────────────────────────┘
                                     │ HTTP / REST API
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                       RAG Assistant Server (FastAPI)                        │
│                                                                             │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │                          文档检索 API                               │     │
│  └────────────────────────────────────────────────────────────────────┘     │
│  ┌────────────────────────────────────────────────────────────────────┐     │
│  │                         RAG 检索引擎                                │     │
│  └────────────────────────────────────────────────────────────────────┘     │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 核心能力 (Core Capabilities)

RAG Assistant 专注于智能文档检索：

| 能力 | 功能描述 | 典型场景 |
|-----|---------|---------|
| 📚 **语义文档检索** | 基于语义理解的文档搜索，超越关键词匹配 | 技术文档、API 规范、设计文档检索 |
| � **混合检索** | Dense + Sparse 双路召回，兼具语义理解和精确匹配 | 同时支持模糊搜索和精确术语匹配 |
| �️ **多模态理解** | 理解文档中的图片、表格等多模态内容 | 流程图、架构图、数据表格检索 |
| 🎯 **精排重排** | Cross-Encoder 精排，提升结果相关性 | 复杂查询的精准匹配 |

#### 双模式交互 (Dual Interaction Modes)

RAG Assistant VS Code 扩展提供两种交互模式：

**模式 A：Webview 聊天界面**
- 独立的聊天窗口，类似 ChatGPT 体验
- 支持文件上传、历史记录、多轮对话
- 适合深度探索和复杂问题

**模式 B：Copilot Chat Participant**
- 通过 `@rag` 命令在 Copilot Chat 中调用
- 与 Copilot 对话无缝集成
- 适合快速查询和上下文相关问题

```
模式 A (Webview):                    模式 B (Chat Participant):
┌─────────────────────┐              ┌─────────────────────────────┐
│ RAG Assistant       │              │ Copilot Chat                │
├─────────────────────┤              ├─────────────────────────────┤
│ 🤖 有什么可以帮您？  │              │ 用户: @rag 搜索             │
│                     │              │       Kubernetes 部署文档   │
│ 👤 搜索 K8s 部署文档 │              │                             │
│                     │              │ 🤖 找到 3 篇相关文档:       │
│ 🤖 找到以下内容:    │              │    1. K8s 部署指南.pdf      │
│    [文档列表...]    │              │    2. 容器化最佳实践.md     │
└─────────────────────┘              └─────────────────────────────┘
```

#### 支持的数据源

**本地文档**：
- **文档格式**：PDF、Excel、PPT、Word
- **图片格式**：PNG、JPG、BMP 等常见格式
- **存储方式**：直接读取本地文件系统

**云端文档**：
- **JIRA Ticket**：通过 REST API 获取 Ticket 内容
- **Confluence**：通过 REST API 获取知识库文档
- **索引方式**：定期自动扫描，本地保存索引目录，按需通过 API 获取原文
- **可扩展**：支持添加更多外部数据源

#### 可扩展架构 (Extensible Architecture)

RAG Assistant 采用高度模块化的可插拔设计：

- **数据源可插拔**：轻松接入新的文档源
- **云端源可扩展**：实现 CloudDataSource 接口即可添加新的外部 API 数据源
- **LLM 可替换**：支持 OpenAI、Azure、Ollama 等多种后端
- **检索策略可配置**：混合检索、语义检索、关键词检索自由组合
- **客户端可扩展**：REST API 设计支持未来接入 Web UI、CLI 等其他客户端

---

## 2. 核心特点

### 2.1 RAG 策略选型 (RAG Strategy Design)

RAG Assistant 采用**多阶段 RAG 架构**，通过"粗排召回 → 融合排序 → 精排重排"的流水线设计，平衡检索效率与回答质量。

#### 2.1.1 整体检索流程

```
用户查询 → 查询处理 → 混合检索 → 融合排序 → 精排重排 → 答案生成 → 最终回答
                        ↓
              ┌────────┴────────┐
              ▼                 ▼
         Dense 检索        Sparse 检索
         (语义向量)         (关键词 BM25)
              └────────┬────────┘
                       ▼
                  RRF 融合
```

#### 2.1.2 各阶段策略

| 阶段 | 策略 | 说明 |
|-----|------|------|
| **分块** | 递归字符分块 | 按段落/句子边界切分，保留语义完整性 |
| **Embedding** | 多语言向量模型 | 支持英日混合文档的语义检索 |
| **粗排** | 混合检索 (Hybrid) | Dense + Sparse 双路召回，互补优势 |
| **融合** | RRF 算法 | 基于排名倒数融合，无需归一化 |
| **精排** | Cross-Encoder | 多语言重排模型，提升结果精度 |
| **生成** | Copilot LLM | 通过 Chat Participant API 生成答案 |

#### 2.1.3 混合检索优势

| 检索类型 | 优势 | 劣势 |
|---------|-----|------|
| **Dense (向量)** | 理解语义、同义词、上下文 | 对精确关键词不敏感 |
| **Sparse (BM25)** | 精确匹配、术语敏感 | 无法理解语义 |
| **Hybrid (混合)** | 兼具两者优势 | — |

#### 2.1.4 策略选型总结

| 阶段 | 默认选择 | 运行位置 | 可替换选项 |
|-----|---------|---------|----------|
| **分块** | 递归字符分块 | 本地 | 固定长度、语义分块 |
| **Embedding** | 多语言模型 | 本地 | 轻量模型 |
| **粗排** | 混合检索 | 本地 | 纯向量、纯关键词 |
| **精排** | Cross-Encoder | 本地 | 轻量模型、禁用 |
| **生成** | Copilot LLM | 云端 | — |

---

### 2.2 全链路可插拔架构 (Pluggable Architecture)

RAG Assistant 采用**全链路可插拔设计**，核心组件均可通过配置切换，无需修改业务代码。

#### 2.2.1 设计原则

| 原则 | 说明 |
|-----|------|
| **接口隔离** | 每类组件定义统一的抽象接口，业务代码仅依赖接口 |
| **配置驱动** | 通过配置文件切换实现，无需改代码 |
| **工厂模式** | 统一的工厂根据配置动态创建组件实例 |
| **优雅降级** | 组件不可用时自动回退到备选方案 |

#### 2.2.2 可插拔组件

| 组件类型 | 职责 | 可替换选项 |
|---------|------|----------|
| **Embedding** | 文本向量化 | 多语言模型 / 轻量模型 |
| **Reranker** | 精排重排 | 多语言模型 / 轻量模型 / 禁用 |
| **Splitter** | 文档分块 | 递归分块 / 语义分块 / 固定分块 |
| **VectorStore** | 向量存储 | ChromaDB / Qdrant / FAISS |
| **Loader** | 文档加载 | PDF / Markdown / Docx / HTML |
| **DataSource** | 数据源 | 本地文件 |
| **Evaluator** | 质量评估 | Ragas / DeepEval / 自定义 |

#### 2.2.3 扩展能力

- **新增组件实现**：实现抽象接口 → 注册到工厂 → 配置启用
- **多环境适配**：开发环境使用轻量组件，生产环境使用高性能组件
- **A/B 测试**：通过配置快速切换不同实现进行对比

---

### 2.3 MCP 生态集成 (MCP Ecosystem Integration)

> **⚠️ 当前状态：可选特性（企业策略限制，暂未启用）**

RAG Assistant 设计上支持 **MCP (Model Context Protocol)** 协议，可作为 MCP Server 被 GitHub Copilot、Claude Desktop 等 MCP Client 调用。

#### 2.3.1 MCP 协议优势

| 优势 | 说明 |
|-----|------|
| **标准化协议** | Anthropic 主导的开放协议，被多个 AI 助手采用 |
| **零前端开发** | 复用现有 MCP Client（Copilot、Claude Desktop） |
| **工具自动发现** | Client 自动识别 Server 提供的工具和资源 |
| **即插即用** | 配置后立即可用，无需额外集成开发 |

#### 2.3.2 支持的 MCP 能力

| 能力 | 说明 |
|-----|------|
| **Tools** | 提供知识检索、文档查询等工具供 Client 调用 |
| **Resources** | 暴露知识库、文档集合等资源供 Client 访问 |
| **Prompts** | 提供预定义的 Prompt 模板 |

#### 2.3.3 当前替代方案

由于企业策略限制，当前采用 **REST API + VS Code 扩展** 方案：

| 方案 | 状态 | 说明 |
|-----|------|------|
| **REST API** | ✅ 主要方案 | 通过 HTTP API 提供服务 |
| **VS Code 扩展** | ✅ 主要方案 | Webview + Chat Participant |
| **MCP Server** | ⏸️ 可选（暂停） | 策略允许时可启用 |

#### 2.3.4 未来启用路径

当企业策略允许时，可通过以下步骤启用 MCP：

1. 配置 MCP Server 端点
2. 在 MCP Client（Copilot/Claude）中注册 Server
3. 通过 MCP 协议调用 RAG Assistant 能力

---

### 2.4 多模态图像处理 (Multimodal Image Processing)

RAG Assistant 支持文档中**图片内容的智能处理与检索**，针对不同类型的图片采用差异化处理策略。

#### 2.4.1 处理策略

| 策略 | 适用场景 | 说明 | 优势 |
|-----|---------|------|------|
| **Image-to-Text** | 截图、照片 | 使用本地 Vision 模型生成图片描述 | 复用现有文本检索流程 |
| **Image-to-Code** | UML 图、架构图 | 将图片转换为 Mermaid.js 代码 | 结构化精准、可渲染还原 |
| **图文关联** | 所有图片 | 图片描述与上下文文本关联存储 | 提升检索相关性 |
| **多格式支持** | 所有图片 | 支持 PNG、JPG、SVG 等常见格式 | 覆盖常见文档图片 |

> [!TIP]
> **UML 图推荐使用 Image-to-Code 策略**：常规 OCR 只能识别"User"和"Login"等单词，无法理解它们之间是"继承"还是"调用"关系。将 UML 图转换为 Mermaid 代码后，代码天然包含逻辑关系，且类名、方法名是精准的文本，极易被检索。

#### 2.4.2 处理流程

**通用图片处理流程**：

| 阶段 | 操作 | 说明 |
|-----|------|------|
| **文档加载** | 提取图片 | 从 PDF/Markdown 中提取嵌入图片 |
| **图片预处理** | 锐化/二值化 | 使用 OpenCV 预处理，提高识别率 |
| **图片描述** | 本地 Vision 模型生成描述 | 将图片转换为文本描述 |
| **向量化** | 描述文本向量化 | 与普通文本块一起存储 |
| **检索匹配** | 通过描述检索图片 | 用户可通过语义查询找到相关图片 |
| **结果返回** | 返回图片与描述 | 答案中附带相关图片引用 |

**UML 图专用处理流程 (Image-to-Code)**：

```
UML 图片 → 预处理 → Vision 模型 → Mermaid 代码 → LLM 语义总结 → 双路索引入库
                              ↓                          ↓
                     向量检索 (Summary)         关键词检索 (Keywords)
                              └──────────┬───────────────┘
                                         ↓
                                    RRF 融合
```

| 阶段 | 操作 | 输出 |
|-----|------|------|
| **代码生成** | Vision 模型转换 UML 图 | Mermaid.js 代码 |
| **语义总结** | LLM 解释代码业务流程 | 文本摘要 (Summary) |
| **关键词提取** | 提取类名、方法名 | 关键词列表 (Keywords) |
| **双路入库** | Summary 向量化 + Keywords 索引 | 向量数据库记录 |

#### 2.4.3 本地 Vision 模型选型

> **硬件配置**：CPU ≥4 核，RAM ≥16GB，GPU ≥8GB VRAM（可选）

| 模型 | 参数规模 | 运行模式 | 推荐场景 |
|-----|---------|---------|---------| 
| **Qwen2.5-VL-3B-Instruct** | 3B | CPU / GPU | **UML 图 + 通用场景**（最佳平衡） |
| **PaddleOCR-VL-1.5** | 0.9B | CPU / GPU | 文档专用（表格/公式/印章） |
| **Florence-2-Large** | 0.77B | CPU / GPU | **极速备选**（详细 Caption） |
| **MiniCPM-V-2.6** | 3B | CPU / GPU | 通用图片理解 |
| **Qwen-VL-Chat** | 7B | GPU only | 高精度需求 |

**推荐选型**：
- **UML 图场景**：`Qwen2.5-VL-3B-Instruct`（3B，支持 Image-to-Code，可在 CPU 上运行）
- **文档场景**：`PaddleOCR-VL-1.5`（0.9B，文档解析 SOTA，表格/公式/印章）
- **极速备选**：`Florence-2-Large`（0.77B，当 Qwen-VL 太慢时使用）

> [!NOTE]
> **CPU 性能参考**：在 4 核 CPU 上，Qwen2.5-VL-3B 处理一张 UML 图约需 15-30 秒；7B 模型可能需要 1-2 分钟且易导致系统卡顿。

> **注意**：由于 Copilot 不支持 Vision 能力，图片描述使用本地 Vision 模型生成。

#### 2.4.4 UML 图的双路索引策略

为提升 UML 图的检索效果，采用 **"代码展示 + 摘要检索"** 的双路索引策略：

| 字段 | 内容示例 | 作用 |
|-----|---------|------|
| **Document Content** | Summary (e.g., "用户登录时序图，先调用API...") | **用于向量检索**。用户搜"登录流程"时命中这里 |
| **Metadata: Code** | `sequenceDiagram User->>API...` | **用于前端展示**。检索命中后，直接把这段代码给前端渲染 |
| **Metadata: Keywords** | `User`, `LoginController`, `AuthService` | **用于关键词检索**。用户搜特定类名时精准命中 |

**优势**：
1. **结构化**：Mermaid 代码天然包含逻辑关系（继承、调用等）
2. **高精度检索**：代码中的类名、方法名是精准的文本，极易被检索
3. **可视化还原**：前端可用 mermaid.js 插件直接把代码渲染回高清矢量图

#### 2.4.5 支持的图片类型

| 类型 | 说明 | 处理方式 | 处理策略 |
|-----|------|---------|---------|
| **UML 图** | 类图、时序图、流程图 | Vision 模型 → Mermaid 代码 | Image-to-Code |
| **架构图** | 系统架构、部署图 | Vision 模型 → Mermaid 代码 | Image-to-Code |
| **截图/照片** | 产品截图、系统界面 | Vision 模型描述 | Image-to-Text |
| **代码截图** | 代码片段截图 | OCR + 描述 | Image-to-Text |
| **表格图片** | 表格截图 | OCR 转文本 | Image-to-Text |

#### 2.4.6 图片预处理

> [!IMPORTANT]
> UML 图往往线条很细，在喂给模型前建议做预处理，能显著提高 3B 模型的识别率。

| 预处理方式 | 说明 | 适用场景 |
|----------|------|---------|
| **锐化处理** | 增强边缘和线条 | 所有 UML 图 |
| **二值化处理** | 黑白转换，去除噪点 | 线条模糊的图片 |
| **对比度增强** | 提高色彩对比度 | 颜色较淡的图片 |

#### 2.4.7 约束与限制

| 约束 | 说明 |
|-----|------|
| **CPU 性能** | 纯 CPU 模式下处理速度较慢，建议离线批量处理 |
| **处理延迟** | 图片描述生成较慢，适合离线批量处理 |
| **精度限制** | 3B 模型偶尔会把箭头方向看反（A->B 看成 B->A） |
| **容错说明** | 在 RAG 场景下方向错误通常可接受，用户可查看原图确认 |

---

### 2.5 可观测性与评估体系 (Observability & Evaluation)

RAG Assistant 内置**全链路追踪**与**RAG 质量评估**能力，支持系统透明化监控与持续优化。

#### 2.5.1 设计目标

| 目标 | 说明 |
|-----|------|
| **白盒化** | RAG 流程各阶段透明可追踪 |
| **可度量** | 检索质量、回答质量可量化评估 |
| **可调优** | 基于数据反馈持续优化策略 |

#### 2.5.2 全链路追踪

每次查询生成唯一 `trace_id`，记录各阶段信息：

| 追踪点 | 记录内容 |
|-------|---------|
| **Query Processing** | 原始查询、改写后查询、提取的关键词 |
| **Dense Retrieval** | 召回文档数、Top-K 结果、耗时 |
| **Sparse Retrieval** | BM25 匹配数、Top-K 结果、耗时 |
| **Fusion** | 融合后排名、RRF 分数 |
| **Rerank** | 重排后排名、Reranker 分数、耗时 |
| **Response** | 最终上下文、LLM 响应、引用来源 |

#### 2.5.3 RAG 质量评估

| 评估维度 | 指标 | 说明 |
|---------|-----|------|
| **检索质量** | Recall@K, Precision@K, MRR | 评估召回与排序效果 |
| **回答质量** | Faithfulness, Relevance | 评估答案忠实度与相关性 |
| **上下文质量** | Context Precision, Context Recall | 评估上下文选取效果 |

#### 2.5.4 评估框架选型

| 框架 | 说明 | 状态 |
|-----|------|------|
| **Ragas** | 开源 RAG 评估框架，支持多维度指标 | 默认选择 |
| **DeepEval** | 提供更多评估指标和基准测试 | 可选 |
| **自定义** | 针对业务场景的定制化评估 | 可扩展 |

#### 2.5.5 可视化与监控

| 能力 | 说明 |
|-----|------|
| **Dashboard** | 可视化展示追踪数据和评估结果 |
| **日志分析** | 结构化日志支持问题诊断 |
| **性能监控** | 各阶段耗时统计与瓶颈分析 |

---

### 2.6 业务可扩展性 (Business Extensibility)

RAG Assistant 设计上支持多种业务场景扩展，可适配不同的数据源和客户端。

#### 2.6.1 多数据源适配

| 数据源类型 | 支持格式 | 获取方式 | 索引策略 |
|----------|---------|---------|----------|
| **本地文档** | PDF, Excel, PPT, Word | 直接读取文件系统 | 文件监控 + 增量更新 |
| **本地图片** | PNG, JPG, BMP 等 | 直接读取文件系统 | 图片转文本后索引 |
| **JIRA Ticket** | Ticket 内容 + 附件 | REST API | 定期扫描 + 索引目录 |
| **Confluence** | 知识库文档 | REST API | 定期扫描 + 索引目录 |

#### 2.6.2 云端文档索引策略

**索引目录模式**：
- 定期自动扫描云端数据源，获取文档元数据（标题、摘要、更新时间等）
- 本地保存索引目录，包含文档 ID、元数据、向量索引
- 当用户检索命中时，再通过 REST API 实时获取完整内容
- 支持增量更新，仅索引变更的文档

```
定期扫描                          检索时
    │                                 │
    ▼                                 ▼
云端 API → 元数据抽取 → 本地索引      索引查询 → 命中文档 → API 获取内容
```

#### 2.6.3 外部数据源扩展

支持通过实现 `CloudDataSource` 接口添加新的云端数据源：

| 扩展方法 | 说明 |
|---------|------|
| **实现接口** | 实现 `CloudDataSource` 抽象接口 |
| **配置连接** | 在 `settings.yaml` 中添加 API 端点和认证信息 |
| **注册数据源** | 在工厂中注册新数据源 |
| **定制解析器** | 实现文档内容解析逻辑 |

#### 2.6.4 多客户端接入

| 客户端 | 接入方式 |
|-------|---------|
| **VS Code 扩展** | Webview + Chat Participant |
| **MCP Client** | MCP 协议 (可选) |
| **Web UI** | REST API + 前端页面 |
| **CLI** | 命令行工具 |

---

## 3. 技术选型

### 3.1 RAG 数据摄取流水线设计 (Ingestion Pipeline)

数据摄取流水线负责将原始文档转换为可检索的向量数据，是 RAG 系统的离线核心模块。

#### 3.1.1 流水线概览

```
原始文档 → 加载 → 分块 → 增强 → 向量化 → 存储
   │        │       │       │        │        │
   ▼        ▼       ▼       ▼        ▼        ▼
 PDF/MD   Loader  Splitter Transform Embedding VectorStore
```

#### 3.1.2 各阶段设计

| 阶段 | 职责 | 输入 | 输出 |
|-----|------|------|------|
| **Loader** | 加载原始文档 | 文件路径/URL | 原始文本 + 元数据 |
| **Splitter** | 文本分块 | 原始文本 | 文本块列表 |
| **Transform** | 内容增强 | 文本块 | 增强后的文本块 |
| **Embedding** | 向量化 | 文本块 | 向量 + 文本块 |
| **Store** | 持久化存储 | 向量 + 元数据 | 向量数据库记录 |

#### 3.1.3 Loader 阶段

**职责**：加载多种格式的原始文档，提取文本内容和元数据。

| 支持格式 | 处理方式 |
|---------|---------|
| **PDF** | 提取文本 + 图片 |
| **Markdown** | 解析结构 + 提取图片 |
| **Word (docx)** | 提取文本 + 表格 |
| **HTML** | 解析 DOM + 清洗 |
| **纯文本** | 直接读取 |

**元数据提取**：
- 文件名、路径、大小、修改时间
- 文档标题、作者（如有）
- 文件 SHA256 哈希（用于去重）

#### 3.1.4 Splitter 阶段

**职责**：将长文档切分为适合检索的文本块。

| 策略 | 说明 | 适用场景 |
|-----|------|---------|
| **递归分块** | 按段落/句子边界切分 | 默认策略 |
| **语义分块** | 基于语义相似度切分 | 高质量需求 |
| **固定分块** | 按固定 Token 数切分 | 简单场景 |

**分块参数**：
- `chunk_size`: 512 tokens
- `chunk_overlap`: 50 tokens

#### 3.1.5 Transform 阶段

**职责**：对文本块进行增强处理，提升检索质量。

| 增强类型 | 说明 |
|---------|------|
| **元数据注入** | 将文件名、标题等信息注入文本块 |
| **图片描述** | 使用 Vision 模型生成图片描述 |
| **内容清洗** | 去除噪音、格式化文本 |

#### 3.1.6 Embedding 阶段

**职责**：将文本块转换为向量表示。

| 模型类型 | 说明 |
|---------|------|
| **多语言模型** | 支持英日混合文档 |
| **本地运行** | 不依赖外部 API |

#### 3.1.7 Store 阶段

**职责**：将向量和元数据持久化存储。

| 存储类型 | 说明 |
|---------|------|
| **向量数据库** | 存储 Embedding 向量 |
| **BM25 索引** | 存储稀疏检索索引 |
| **元数据存储** | 存储文档元信息 |

#### 3.1.8 去重与增量更新

| 机制 | 说明 |
|-----|------|
| **文件级去重** | 基于 SHA256 哈希判断文件是否已处理 |
| **增量更新** | 仅处理新增或修改的文件 |
| **幂等写入** | 重复摄取不产生重复数据 |

### 3.2 RAG 检索流水线设计 (Retrieval Pipeline)

检索流水线负责处理用户查询并返回相关文档，是 RAG 系统的在线核心模块。

#### 3.2.1 流水线概览

```
用户查询 → 查询处理 → 双路检索 → 融合排序 → 精排重排 → 上下文构建 → 返回结果
                         ↓
               ┌────────┴────────┐
               ▼                 ▼
          Dense 检索        Sparse 检索
               └────────┬────────┘
                        ▼
                   RRF 融合
```

#### 3.2.2 各阶段设计

| 阶段 | 职责 | 输入 | 输出 |
|-----|------|------|------|
| **Query Processing** | 查询理解与预处理 | 原始查询 | 处理后的查询 |
| **Dense Retrieval** | 语义向量检索 | 查询向量 | Top-K 候选文档 |
| **Sparse Retrieval** | 关键词 BM25 检索 | 查询关键词 | Top-K 候选文档 |
| **Fusion** | 结果融合排序 | 双路候选 | 融合后排名 |
| **Rerank** | 精排重排 | 融合结果 | 最终 Top-K |
| **Context Build** | 上下文构建 | Top-K 文档 | 格式化上下文 |

#### 3.2.3 Query Processing 阶段

**职责**：对用户查询进行预处理，提升检索效果。

| 处理类型 | 说明 |
|---------|------|
| **查询清洗** | 去除噪音字符、规范化格式 |
| **关键词提取** | 提取核心关键词用于 BM25 检索 |
| **查询向量化** | 使用 Embedding 模型生成查询向量 |

#### 3.2.4 Dense Retrieval 阶段

**职责**：基于语义向量相似度检索相关文档。

| 要素 | 说明 |
|-----|------|
| **相似度算法** | 余弦相似度 / 内积 |
| **Top-K** | 默认召回 20 条 |
| **模型** | 与摄取阶段使用相同的 Embedding 模型 |

#### 3.2.5 Sparse Retrieval 阶段

**职责**：基于关键词匹配检索相关文档。

| 要素 | 说明 |
|-----|------|
| **算法** | BM25 |
| **Top-K** | 默认召回 20 条 |
| **优势** | 对专业术语、精确关键词敏感 |

#### 3.2.6 Fusion 阶段

**职责**：融合 Dense 和 Sparse 检索结果。

| 融合算法 | 说明 |
|---------|------|
| **RRF** | Reciprocal Rank Fusion，基于排名倒数融合 |
| **参数** | k=60（默认） |
| **优势** | 无需归一化，简单高效 |

#### 3.2.7 Rerank 阶段

**职责**：使用精排模型对融合结果重新排序。

| 要素 | 说明 |
|-----|------|
| **模型** | Cross-Encoder（多语言） |
| **Top-K** | 精排后返回 5 条 |
| **可选** | 可通过配置禁用 |

#### 3.2.8 Context Build 阶段

**职责**：将检索结果构建为 LLM 可用的上下文。

| 要素 | 说明 |
|-----|------|
| **格式化** | 按模板组装文档内容 |
| **引用标注** | 为每个文档块添加来源标识 |
| **长度控制** | 控制上下文总长度不超过 Token 限制 |

### 3.3 可插拔架构设计 (Pluggable Architecture Design)

本项目在架构设计上追求极致的灵活性，整个系统的每一个核心环节均定义了抽象接口，支持"乐高积木式"的自由替换与组合。

#### 3.3.1 设计原则

| 原则 | 说明 |
|-----|------|
| **接口隔离** | 为每类组件定义最小化的抽象接口，上层业务逻辑仅依赖接口而非具体实现 |
| **配置驱动** | 通过统一配置文件指定各组件的具体后端，代码无需修改即可切换实现 |
| **工厂模式** | 使用工厂函数根据配置动态实例化对应的实现类 |
| **优雅降级** | 当首选后端不可用时，系统应自动回退到备选方案或安全默认值 |

**通用结构示意**：

```
业务代码
  │
  ▼
<Component>Factory.get_xxx()  ← 读取配置，决定用哪个实现
  │
  ├─→ ImplementationA()
  ├─→ ImplementationB()  
  └─→ ImplementationC()
      │
      ▼
    都实现了统一的抽象接口
```

#### 3.3.2 Embedding 提供者抽象

| 提供者类型 | 典型场景 | 配置切换点 |
|---------|---------|-----------| 
| **本地模型** | 离线部署、隐私敏感 | `provider: local`, `model: multilingual-e5-base` |
| **OpenAI** | 云端服务、最新模型 | `provider: openai`, `api_key`, `model` |
| **Ollama** | 本地私有化部署 | `provider: ollama`, `base_url`, `model` |

#### 3.3.3 Rerank 提供者抽象

| 提供者类型 | 典型场景 | 配置切换点 |
|---------|---------|-----------| 
| **本地 Cross-Encoder** | 默认方案、离线部署 | `provider: local`, `model: bge-reranker-v2-m3` |
| **禁用** | 低延迟需求 | `provider: none` |
| **轻量模型** | CPU 环境 | `provider: local`, `model: ms-marco-MiniLM-L-6-v2` |

#### 3.3.4 向量数据库抽象

| 后端 | 特点 | 配置切换点 |
|-----|------|-----------|
| **Chroma** | 嵌入式、零配置、适合本地开发 | `backend: chroma` |
| **Qdrant** | 高性能、支持分布式 | `backend: qdrant`, `url` |
| **Milvus** | 企业级、大规模数据 | `backend: milvus`, `url` |

#### 3.3.5 检索策略抽象

| 策略 | 说明 | 配置切换点 |
|-----|------|-----------|
| **混合检索** | Dense + Sparse + RRF 融合 | `strategy: hybrid` |
| **纯向量检索** | 仅 Dense 检索 | `strategy: dense_only` |
| **纯关键词检索** | 仅 BM25 检索 | `strategy: sparse_only` |

#### 3.3.6 评估框架抽象

| 框架 | 特点 | 适用场景 |
|-----|------|---------|
| **Ragas** | RAG 专用、指标丰富 | 全面评估 RAG 质量 |
| **DeepEval** | LLM-as-Judge 模式 | 需要主观质量判断 |
| **自定义指标** | Hit Rate, MRR, Latency | 快速回归测试 |

#### 3.3.7 配置管理

**配置文件结构** (`config/settings.yaml`)：

```yaml
embedding:
  provider: local  # local | openai | ollama
  model: multilingual-e5-base

rerank:
  provider: local  # local | none
  model: bge-reranker-v2-m3

vector_store:
  backend: chroma  # chroma | qdrant | milvus

retrieval:
  strategy: hybrid  # hybrid | dense_only | sparse_only
  sparse_backend: bm25
  fusion_algorithm: rrf

evaluation:
  backends: [ragas, custom_metrics]
```

**切换流程**：
1. 修改 `settings.yaml` 中对应组件的 `provider` / `backend` 字段
2. 确保新后端的依赖已安装
3. 重启服务，工厂函数自动加载新实现

### 3.4 可观测性与追踪设计 (Observability & Tracing Design)

针对 RAG 系统常见的"黑盒"问题，设计全链路可观测的追踪体系，使每一次检索与生成过程都透明可见且可量化。

#### 3.4.1 设计理念

| 理念 | 说明 |
|-----|------|
| **请求级全链路追踪** | 以 `trace_id` 为核心，完整记录单次请求从输入到输出的全过程 |
| **透明可回溯** | 每个阶段的中间状态都被记录，开发者可清晰定位问题 |
| **低侵入性** | 追踪逻辑与业务逻辑解耦，通过装饰器或回调机制注入 |
| **轻量本地化** | 采用结构化日志 + 本地 Dashboard，零外部依赖 |

#### 3.4.2 追踪数据结构

**基础信息**：
- `trace_id`：请求唯一标识
- `timestamp`：请求时间戳
- `user_query`：用户原始查询
- `collection`：检索的知识库集合

**各阶段详情 (Stages)**：

| 阶段 | 记录内容 |
|-----|---------|
| **Query Processing** | 原始 Query、改写后 Query、提取的关键词、耗时 |
| **Dense Retrieval** | Top-N 候选及相似度分数、耗时 |
| **Sparse Retrieval** | Top-N 候选及 BM25 分数、耗时 |
| **Fusion** | 融合后的统一排名、耗时 |
| **Rerank** | 重排后的最终排名及分数、耗时 |

**汇总指标**：
- `total_latency`：端到端总耗时
- `top_k_results`：最终返回的 Top-K 文档 ID
- `error`：异常信息（若有）

#### 3.4.3 技术方案

采用"结构化日志 + 本地 Web Dashboard"实现方案：

```
RAG Pipeline
    │
    ▼
Trace Collector (装饰器/回调)
    │
    ▼
JSON Lines 日志文件 (logs/traces.jsonl)
    │
    ▼
本地 Web Dashboard (Streamlit)
    │
    ▼
按 trace_id 查看各阶段详情与性能指标
```

**核心组件**：
- **结构化日志层**：基于 Python logging + JSON Formatter，将 Trace 数据以 JSON Lines 格式追加写入本地文件
- **本地 Web Dashboard**：基于 Streamlit 构建的轻量级 Web UI，读取日志文件并提供交互式可视化

#### 3.4.4 Dashboard 功能

| 功能 | 说明 |
|-----|------|
| **请求列表** | 按时间倒序展示历史请求，支持按 Query 关键词筛选 |
| **耗时瀑布图** | 展示各阶段的时间分布，快速定位性能瓶颈 |
| **阶段详情** | 点击任意阶段，查看该阶段的输入、输出与关键参数 |
| **召回结果表** | 展示 Top-K 候选文档在各阶段的排名与分数变化 |

#### 3.4.5 配置示例

```yaml
observability:
  enabled: true
  
  logging:
    log_file: logs/traces.jsonl
    log_level: INFO  # DEBUG | INFO | WARNING
  
  detail_level: standard  # minimal | standard | verbose
  
  dashboard:
    enabled: true
    port: 8501
```

### 3.5 REST API 设计 (REST API Design)

RAG Assistant Server 通过 REST API 向客户端提供 RAG 检索服务，使其能够作为知识上下文提供者，对接 VS Code 扩展和其他客户端。

#### 3.5.1 核心设计理念

| 理念 | 说明 |
|-----|------|
| **RESTful 规范** | 遵循 REST 架构风格，使用标准 HTTP 方法和状态码 |
| **开箱即用** | 客户端无需特殊配置，只需知道 API 端点即可使用 |
| **引用透明** | 所有检索结果必须携带完整的来源信息，支持展示"回答依据" |
| **多模态友好** | 返回格式支持文本与图像等多种内容类型 |

#### 3.5.2 核心 API 接口

| 接口 | 方法 | 功能描述 |
|-----|------|---------|
| `/api/query` | POST | 主检索入口，执行混合检索 + Rerank，返回最相关片段 |
| `/api/collections` | GET | 列举知识库中可用的文档集合 |
| `/api/documents/{id}` | GET | 获取指定文档的摘要与元信息 |
| `/api/ingest` | POST | 上传并摄取文档到知识库 |
| `/api/health` | GET | 健康检查接口 |

#### 3.5.3 查询接口详细设计

**请求格式** (`POST /api/query`)：

```json
{
  "query": "如何部署 Kubernetes?",
  "top_k": 5,
  "collection": "tech-docs",
  "filters": {
    "doc_type": "markdown"
  }
}
```

**响应格式**：

```json
{
  "trace_id": "abc123",
  "results": [
    {
      "chunk_id": "chunk_001",
      "content": "Kubernetes 部署步骤...",
      "source": "k8s-guide.pdf",
      "page": 5,
      "score": 0.92,
      "metadata": {}
    }
  ],
  "context": "格式化的上下文字符串，可直接用于 LLM Prompt",
  "latency_ms": 150
}
```

#### 3.5.4 引用透明设计

每个检索结果片段包含完整的定位信息：
- `source_file`：文件名/路径
- `page`：页码（如适用）
- `chunk_id`：片段标识
- `score`：相关性分数

**引用格式**：在返回的上下文中以 `[1]`、`[2]` 等标注引用来源。

#### 3.5.5 多模态内容返回

| 内容类型 | 说明 |
|---------|------|
| **文本** | 默认返回类型，Markdown 格式 |
| **图像** | 当检索结果关联图像时，返回 Base64 编码或图片 URL |

#### 3.5.6 错误处理

| HTTP 状态码 | 说明 |
|------------|------|
| 200 | 成功 |
| 400 | 请求参数错误 |
| 404 | 资源不存在 |
| 500 | 服务器内部错误 |

---

### 3.6 多模态图片处理设计 (Multimodal Image Processing Design)

设计一套完整的图片处理方案，使 RAG 系统能够理解、索引并检索文档中的图片内容，实现"用自然语言搜索图片"的能力。

#### 3.6.1 策略选型

| 策略 | 核心思路 | 优势 | 劣势 |
|-----|---------|------|------|
| **Image-to-Text** | 利用 Vision 模型将图片转化为文本描述 | 架构统一、实现简单 | 描述质量依赖模型能力 |
| **Multi-Embedding** | 使用 CLIP 等模型将图文映射到同一向量空间 | 保留原始视觉特征 | 架构复杂度高 |

**本项目选型：Image-to-Text（图转文）策略**

选型理由：
- 架构统一，完全复用现有的文本 RAG 链路
- 语义对齐，图片描述与用户查询在同一语义空间
- 成本可控，仅在摄取阶段一次性调用 Vision 模型

#### 3.6.2 处理全流程

```
原始文档 (PDF/Markdown)
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│  Loader 阶段：图片提取与引用收集                           │
│  - 识别并提取嵌入的图片资源                                │
│  - 为每张图片生成唯一标识 (image_id)                       │
│  - 在文本中插入图片占位符                                  │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│  Transform 阶段：图片理解与描述生成                         │
│  - 调用 Vision 模型对每张图片生成结构化描述                  │
│  - 将描述文本注入到关联 Chunk 中                           │
└─────────────────────────────────────────────────────────┘
    │
    ▼
┌─────────────────────────────────────────────────────────┐
│  Storage 阶段：双轨存储                                    │
│  - 向量库：存储增强后的 Chunk (含图片描述)                   │
│  - 文件系统：存储原始图片文件用于返回展示                     │
└─────────────────────────────────────────────────────────┘
```

#### 3.6.3 Vision 模型选型

| 模型 | 特点 | 硬件要求 |
|-----|------|---------|
| **PaddleOCR-VL-1.5** | 文档专用，0.9B 超轻量，SOTA | ≥4GB RAM |
| **MiniCPM-V-2.6** | 通用图片理解，多语言 | ≥8GB RAM |
| **Qwen-VL-Chat** | 高精度，中文能力强 | ≥8GB VRAM |

> **模型地址**：https://huggingface.co/PaddlePaddle/PaddleOCR-VL-1.5

#### 3.6.4 图片描述生成策略

| 图片类型 | 处理策略 |
|---------|---------|
| **流程图/架构图** | 提取节点关系、流程步骤 |
| **表格/图表** | 提取数据、趋势描述 |
| **截图** | OCR 文字识别 + 界面描述 |
| **插图/照片** | 场景描述、主体识别 |

---

## 4. 测试方案

### 4.1 测试策略与原则

**核心原则**：
- **早测试、常测试**：在开发过程中持续进行测试，而非最后阶段集中测试
- **测试即文档**：测试用例本身作为系统行为的可执行文档
- **快速反馈循环**：本地开发时能快速运行测试，获得即时反馈
- **分层测试金字塔**：单元测试多、集成测试中、端到端测试少

```
        /\
       /E2E\         <- 少量，验证关键业务流程
      /------\
     /Integration\   <- 中量，验证模块协作
    /------------\
   /  Unit Tests  \  <- 大量，验证单个函数/类
  /________________\
```

### 4.2 测试分层策略

#### 4.2.1 单元测试 (Unit Tests)

**目标**：验证每个独立组件的内部逻辑正确性，隔离外部依赖。

| 模块 | 测试重点 | 典型测试用例 |
|-----|---------|------------|
| **Loader** | 文档解析正确性 | 不同格式文档加载、元数据提取 |
| **Splitter** | 分块逻辑 | 边界情况、重叠处理、长文本 |
| **Embedding** | 向量化输出 | 输出维度、批处理、空输入 |
| **Retriever** | 检索逻辑 | 相似度计算、Top-K 排序 |
| **Reranker** | 重排逻辑 | 分数计算、排序正确性 |

**技术选型**：
- **测试框架**：`pytest`
- **Mock 工具**：`pytest-mock`、`unittest.mock`

#### 4.2.2 集成测试 (Integration Tests)

**目标**：验证多个组件协作时的数据流转与接口兼容性。

| 测试场景 | 验证要点 | 测试策略 |
|---------|---------|---------|
| **摄取流水线** | Loader → Splitter → Embedding → Store | 使用测试文档验证端到端流程 |
| **检索流水线** | Query → Dense/Sparse → Fusion → Rerank | 使用已索引数据验证检索质量 |
| **API 集成** | REST API → 后端服务 | 验证请求响应格式 |

#### 4.2.3 端到端测试 (End-to-End Tests)

**目标**：模拟真实用户操作，验证完整业务流程的可用性。

**场景 1：文档摄取与检索**
- **测试目标**：验证文档从上传到可检索的完整流程
- **测试步骤**：上传文档 → 等待摄取完成 → 执行检索 → 验证结果
- **验证要点**：检索结果包含预期内容

**场景 2：多模态图片检索**
- **测试目标**：验证图片描述生成与检索
- **测试步骤**：上传含图片文档 → 验证图片描述 → 使用自然语言检索图片
- **验证要点**：检索结果关联正确的图片

### 4.3 RAG 质量评估测试

**目标**：使用标准化 RAG 评估指标验证检索与回答质量。

**评估指标**：

| 指标 | 说明 | 目标值 |
|-----|------|-------|
| **Recall@K** | Top-K 结果中包含相关文档的比例 | ≥0.8 |
| **MRR** | 第一个相关结果的排名倒数均值 | ≥0.7 |
| **Faithfulness** | 回答与检索上下文的一致性 | ≥0.85 |
| **Relevance** | 回答与用户问题的相关性 | ≥0.8 |

**评估框架**：Ragas（默认）

### 4.4 性能测试

| 测试类型 | 验证点 | 目标 |
|---------|-------|------|
| **检索延迟** | 单次检索响应时间 | ≤500ms |
| **摄取吞吐量** | 每分钟处理文档数 | ≥10 docs/min |
| **并发能力** | 同时处理请求数 | ≥10 requests |

### 4.5 测试工具链

| 工具 | 用途 |
|-----|------|
| **pytest** | 测试框架 |
| **pytest-cov** | 代码覆盖率 |
| **pytest-asyncio** | 异步测试 |
| **Ragas** | RAG 评估 |

---

## 5. 系统架构与模块设计

### 5.1 整体架构图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              外部调用层                                       │
│                                                                             │
│    ┌─────────────────┐    ┌─────────────────┐                              │
│    │  VS Code 扩展    │    │    Web UI       │                              │
│    └────────┬────────┘    └────────┬────────┘                              │
│             └──────────────────────┼──────────────────────┘                 │
│                                    │  REST API                              │
└────────────────────────────────────┼────────────────────────────────────────┘
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              接口层                                          │
│    ┌─────────────────────────────────────────────────────────────────┐      │
│    │                       FastAPI Server                            │      │
│    └─────────────────────────────────────────────────────────────────┘      │
└────────────────────────────────────┬────────────────────────────────────────┘
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              核心业务层                                       │
│  ┌───────────────────────────────────────────────────────────────────────┐  │
│  │                            RAG Engine                                 │  │
│  │  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐        │  │
│  │  │   Ingestion     │  │   Retrieval     │  │   Transform     │        │  │
│  │  └─────────────────┘  └─────────────────┘  └─────────────────┘        │  │
│  └───────────────────────────────────────────────────────────────────────┘  │
└────────────────────────────────────┬────────────────────────────────────────┘
                                     ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              存储层                                          │
│    ┌──────────────────────┐    ┌──────────────────────┐                     │
│    │    向量数据库 (Chroma) │    │   文件存储 (本地)     │                     │
│    └──────────────────────┘    └──────────────────────┘                     │
└─────────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────────┐
│                              可插拔抽象层                                     │
│  ┌────────────┐ ┌────────────┐ ┌────────────┐ ┌────────────┐                │
│  │ Embedding  │ │  Rerank    │ │ VectorStore│ │ Evaluator  │                │
│  └────────────┘ └────────────┘ └────────────┘ └────────────┘                │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 5.2 目录结构

```
rag-assistant/
│
├── config/                              # 配置文件目录
│   └── settings.yaml                    # 主配置文件
│
├── src/                                 # 源代码主目录
│   │
│   ├── api/                             # REST API 接口层
│   │   ├── __init__.py
│   │   ├── main.py                      # FastAPI 入口
│   │   └── routes/                      # API 路由
│   │
│   ├── rag/                             # RAG 核心引擎
│   │   ├── ingestion/                   # 数据摄取流水线
│   │   ├── retrieval/                   # 检索流水线
│   │   └── transform/                   # 数据转换
│   │
│   ├── libs/                            # 可插拔抽象层
│   │   ├── embedding/                   # Embedding 抽象
│   │   ├── rerank/                      # Rerank 抽象
│   │   ├── vectorstore/                 # 向量数据库抽象
│   │   └── evaluator/                   # 评估框架抽象
│   │
│   └── observability/                   # 可观测性
│       ├── logger.py                    # 结构化日志
│       └── dashboard/                   # Streamlit Dashboard
│
├── data/                                # 数据目录
│   ├── documents/                       # 原始文档
│   └── images/                          # 提取的图片
│
├── logs/                                # 日志目录
│
├── tests/                               # 测试目录
│   ├── unit/                            # 单元测试
│   ├── integration/                     # 集成测试
│   └── fixtures/                        # 测试数据
│
├── main.py                              # 入口文件
├── pyproject.toml                       # Python 项目配置
└── README.md                            # 项目说明
```

### 5.3 模块说明

#### 5.3.1 接口层

| 模块 | 职责 | 关键技术点 |
|-----|-----|----------|
| `api/main.py` | FastAPI 应用入口 | 路由注册、中间件配置 |
| `api/routes/` | API 路由定义 | 请求验证、响应格式化 |

#### 5.3.2 核心业务层

| 模块 | 职责 | 关键技术点 |
|-----|-----|----------|
| `rag/ingestion/` | 数据摄取流水线 | Loader、Splitter、Embedding |
| `rag/retrieval/` | 检索流水线 | Hybrid Search、Rerank、Fusion |
| `rag/transform/` | 数据转换 | 图片处理、内容增强 |

#### 5.3.3 可插拔抽象层

| 抽象接口 | 当前默认实现 | 可替换选项 |
|---------|------------|----------|
| `EmbeddingProvider` | multilingual-e5-base | OpenAI、Ollama |
| `RerankProvider` | bge-reranker-v2-m3 | ms-marco-MiniLM、None |
| `VectorStoreProvider` | Chroma | Qdrant、Milvus |
| `EvaluatorProvider` | Ragas | DeepEval、Custom |

### 5.4 数据流说明

#### 5.4.1 数据摄取流程

```
文档上传 → Loader → Splitter → Transform → Embedding → VectorStore
```

#### 5.4.2 检索流程

```
用户查询 → Query Processing → Hybrid Search → Fusion → Rerank → Context Build → 返回结果
```

---

## 6. 项目排期

> **排期原则**
> 
> - **业务需求驱动**：优先实现核心 RAG 能力，确保系统可用
> - **增量交付**：每个阶段交付可验证的功能增量
> - **持续集成**：每个任务都有明确的验收标准

### 阶段总览

| 阶段 | 名称 | 目标 |
|-----|------|------|
| A | 基础架构搭建 | 项目骨架、配置管理、基础 API |
| B | RAG 核心流水线 | 摄取与检索流水线完整实现 |
| C | 高级特性 | 混合检索、Rerank、多模态图片 |
| D | 可观测性与评估 | Dashboard、评估框架集成 |
| E | 优化与文档 | 性能优化、完善文档 |

---

### 阶段 A：基础架构搭建

| 任务 | 说明 | 验收标准 |
|-----|------|---------|
| A1：项目初始化 ✅ | 创建项目结构、依赖管理 | `pip install -e .` 成功 |
| A2：配置管理 ✅ | 实现配置加载与验证 | 配置可正确加载 |
| A3：REST API 骨架 ✅ | FastAPI 基础路由 | `/api/health` 返回 200 |

---

### 阶段 B：RAG 核心流水线

| 任务 | 说明 | 验收标准 |
|-----|------|---------|
| B1：Loader 实现 ✅ | PDF/Markdown/Word 加载 | 文档可正确解析 |
| B2：Splitter 实现 ✅ | 递归分块策略 | 分块大小符合配置 |
| B3：Embedding 抽象 ✅ | 本地模型集成 | 向量维度正确 |
| B4：VectorStore 集成 ✅ | Chroma 集成 | 文档可存储和查询 |
| B5：基础检索 API ✅ | `/api/query` 实现 | 检索返回相关结果 |

---

### 阶段 C：高级特性

| 任务 | 说明 | 验收标准 |
|-----|------|---------|
| C1：BM25 稀疏检索 ✅ | BM25 索引实现 | 稀疏检索正常工作 |
| C2：RRF 融合 ✅ | 混合检索融合 | 融合结果优于单一策略 |
| C3：Rerank 集成 ✅ | Cross-Encoder 重排 | 重排后排序更优 |
| C4：多模态图片处理 ❌ | Vision 模型集成 | 已移除（模型加载慢） |

---

### 阶段 D：可观测性与评估

| 任务 | 说明 | 验收标准 |
|-----|------|---------|
| D1：结构化日志 ✅ | Trace 日志记录 | 各阶段日志完整 |
| D2：Dashboard ✅ | Streamlit UI | 可查看请求详情 |
| D3：评估框架 ✅ | Ragas 集成 | 可计算评估指标 |

---

### 阶段 E：优化与文档

| 任务 | 说明 | 验收标准 |
|-----|------|---------|
| E1：性能优化 ✅ | 批处理、缓存 | 延迟达标 |
| E2：README 完善 ✅ | 使用说明 | 新用户可快速上手 |
| E3：API 文档 ✅ | OpenAPI 文档 | Swagger UI 可访问 |

---

### 阶段 F：VS Code 扩展

| 任务 | 说明 | 验收标准 |
|-----|------|---------| 
| F1：项目初始化 | TypeScript 项目配置 | 扩展可加载 |
| F2：WebView 界面 | 聊天界面实现 | 消息可发送接收 |
| F3：RAG API 对接 | REST 客户端 | 检索结果正确显示 |
| F4：文件上传 | 上传到 RAG Server | 文件可上传成功 |
| F5：Copilot 集成 | GPT-4o 回答生成 | RAG 增强回答可用 |
| F6：测试与打包 | VSIX 打包 | 可安装使用 |

---

## 7. 可扩展性与未来展望

### 7.1 新数据源扩展

**当前支持**：
- 本地文档：PDF、Excel、PPT、Word、图片
- 云端文档：JIRA Ticket、Confluence（通过 REST API）

**扩展方向**：
- **更多云端源**：通过实现 `CloudDataSource` 接口添加新的外部 API 数据源
- **企业知识库**：Notion、SharePoint 等在线存储

### 7.2 更多客户端接入

当前支持：VS Code 扩展、REST API

**扩展方向**：
- **Web UI**：提供独立的 Web 界面
- **CLI 工具**：命令行检索工具
- **MCP 协议**：可选支持 MCP 协议对接更多客户端

### 7.3 高级 RAG 策略

**扩展方向**：
- **Agentic RAG**：结合 Agent 进行多轮对话
- **Graph RAG**：引入知识图谱增强检索
- **Self-RAG**：自我反思与迭代检索

### 7.4 企业级能力

**扩展方向**：
- **权限管理**：文档级别访问控制
- **分布式部署**：支持多节点扩展
- **监控告警**：对接 Prometheus/Grafana

